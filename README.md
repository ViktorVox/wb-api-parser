# Тестовое задание: Парсер API (Laravel 11)

Бэкенд-сервис для фоновой синхронизации данных из внешнего REST API (Склады, Заказы, Продажи, Доходы) в удаленную облачную базу данных MySQL.

## Доступы к удаленной БД (Filess.io MySQL)

База данных успешно развернута в облаке, исторические данные полностью выкачаны и сохранены (выгрузка с 10.02.2026).

* **Host:** `kvfw1j.h.filess.io`
* **Port:** `61002`
* **Database:** `db_wb_api_parser_labelvapor`
* **Username:** `db_wb_api_parser_labelvapor`
* **Password:** `971484401ebda783a2ba7bff6dc4f6d00f2032b1`

**Названия заполненных таблиц:** `stocks`, `orders`, `sales`, `incomes`.

---

## Особенности реализации (Engineering Decisions)

1. **Обход жестких лимитов Swoole / WAF:**
   * В ходе дебага было выявлено, что сервер на Laravel Octane (Swoole) сбрасывает TCP-соединения (`cURL error 52`) и выдает `403 Forbidden` на стандартные запросы от `GuzzleHttp`.
   * **Решение:** Реализована полная маскировка запросов под HTTP-клиент (подмена `User-Agent`, `Accept-Encoding: gzip, deflate, br`, `Connection: keep-alive`). Парсинг работает стабильно.

2. **Оптимизация N+1 и массовая вставка (Batch Upsert):**
   * Вместо одиночных запросов `updateOrCreate` в цикле, реализована пакетная выгрузка данных (Массовый `upsert`) чанками. Это сократило количество SQL-запросов к удаленной базе в 10 раз и кратно ускорило синхронизацию. 
   * Идемпотентность сохранена за счет уникальных составных индексов на уровне БД (например, `income_id` + `barcode`). При рестартах дубликаты не плодятся.

3. **Защита от таймаутов (2006 MySQL server has gone away):**
   * При длительном ожидании ответа от стороннего API бесплатные облачные БД часто закрывают соединение. Добавлен жесткий сброс и переподключение (`DB::purge()` и `DB::reconnect()`) перед каждой транзакцией вставки батча.

4. **Динамическая пагинация:**
   * Парсер автоматически забирает `last_page` из мета-данных ответа и обходит все страницы через цикл `do-while` до полного истощения пула данных.

## Стек технологий

* **PHP:** 8.3
* **Фреймворк:** Laravel 11
* **БД:** MySQL 8
* **Окружение:** OS Windows 11 LTSC + WSL 2 + Docker (Laravel Sail)

## Доступные консольные команды (Artisan)

Так как проект развернут в Docker-окружении (Laravel Sail), все команды выполняются через бинарник Sail. Они реализованы в виде изолированных процессов, готовых для постановки в Cron (Task Scheduling):

```bash
# Синхронизация складов
./vendor/bin/sail artisan api:sync-stocks

# Синхронизация заказов 
./vendor/bin/sail artisan api:sync-orders

# Синхронизация продаж
./vendor/bin/sail artisan api:sync-sales

# Синхронизация доходов/поставок
./vendor/bin/sail artisan api:sync-incomes
